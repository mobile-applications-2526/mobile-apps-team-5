<ng-container *ngIf="user">

  <div class="profile-top">
    <ion-avatar class="big-avatar">
      <div class="initials">{{ getInitials() }}</div>
    </ion-avatar>

    <div class="counts">
      <div class="count" (click)="goToFriendsPage()" style="cursor: pointer;">
        <div class="num">{{ user.friendsCount || 0 }}</div>
        <div class="label">Friends</div>
      </div>
    </div>
  </div>

  <div class="profile-body">
    <h2 *ngIf="!edit">{{ user.full_name }}</h2>

    <div *ngIf="!edit" class="location">{{ user.location || 'Leuven, BE' }}</div>

    <div class="section">
      <div class="section-header">
        <span>Self-introduction</span>
        <ion-button fill="clear" size="small" (click)="toggleEdit()">
          <ion-icon [name]="edit ? 'close' : 'create'"></ion-icon>
        </ion-button>
      </div>

      <div *ngIf="!edit" class="bio-box">
        {{ user.bio || 'Add a bio to introduce yourself...' }}
      </div>

      <form *ngIf="edit" [formGroup]="form">

        <ion-item class="ion-margin-bottom">
          <ion-label position="stacked">Name</ion-label>
          <ion-input formControlName="name"></ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Bio</ion-label>
          <ion-textarea formControlName="bio" rows="3"></ion-textarea>
        </ion-item>

        <!-- new section for interests editing -->
        <div class="section">
          <h3 style="margin-top: 16px;">Interests</h3>

          <!-- Loading state -->
          <div *ngIf="loadingInterests">
            <ion-skeleton-text
              animated
              style="width: 100%; height: 40px; margin-bottom: 8px;">
            </ion-skeleton-text>
          </div>

          <!-- Checkbox list once interests are loaded -->
          <div *ngIf="!loadingInterests">
            <ion-item
              lines="none"
              *ngFor="let interest of allInterests">
              
              <ion-checkbox
                slot="start"
                [checked]="form.value.interests?.includes(interest.name)"
                (ionChange)="onInterestToggle(interest.name, $event.detail.checked)">
              </ion-checkbox>

              <ion-label>{{ interest.name }}</ion-label>
            </ion-item>

            <p *ngIf="allInterests.length === 0" style="color: gray; font-size: 0.9em;">
              No interests available.
            </p>
          </div>
        </div>

        <div class="actions" style="margin-top: 15px;">
          <ion-button fill="clear" (click)="toggleEdit()">Cancel</ion-button>
          <ion-button (click)="save()" [disabled]="loading">
            {{ loading ? 'Saving...' : 'Save' }}
          </ion-button>
        </div>
      </form>
    </div>

    <div class="section" *ngIf="!edit">
      <h3>Interests</h3>
      <div class="chips">
        <ion-chip *ngFor="let i of user.interests || []">{{ i }}</ion-chip>
        <p *ngIf="!user.interests?.length" style="color:gray; font-size: 0.9em;">
          No interests added.
        </p>
      </div>
    </div>

    <div class="section">
      <h3>Languages</h3>
      <div class="chips">
        <ion-chip *ngFor="let l of user.languages || []">{{ l }}</ion-chip>
        <p *ngIf="!user.languages?.length" style="color:gray; font-size: 0.9em;">No languages added.</p>
      </div>
    </div>

    <div class="section">
      <h3>Upcoming activities</h3>
      
      <div *ngIf="loadingActivities">
        <ion-skeleton-text animated style="width: 100%; height: 80px; margin-bottom: 10px;"></ion-skeleton-text>
      </div>
    
      <div *ngIf="!loadingActivities">
        <div *ngFor="let event of upcomingEvents" style="margin-bottom: 10px;">
          <app-saved-event 
            [event]="event" 
            (removeClicked)="onItemRemoved($event)">
          </app-saved-event>
        </div>
        
        <p *ngIf="upcomingEvents.length === 0" style="color:gray; font-size: 0.9em;">
          No upcoming activities.
        </p>
      </div>
    </div>

    <div class="section">
      <h3>Past activities</h3>
    
      <div *ngIf="loadingActivities">
        <ion-skeleton-text animated style="width: 100%; height: 80px; margin-bottom: 10px;"></ion-skeleton-text>
      </div>
    
      <div *ngIf="!loadingActivities">
        <div *ngFor="let event of pastEvents" style="margin-bottom: 10px;">
          <app-saved-event 
            [event]="event" 
            (removeClicked)="onItemRemoved($event)">
          </app-saved-event>
        </div>
    
        <p *ngIf="pastEvents.length === 0" style="color:gray; font-size: 0.9em;">
          No past activities.
        </p>
      </div>
    </div>

    <div class="logout-section" style="margin-top: 40px; margin-bottom: 80px;">
      <ion-button expand="block" color="danger" (click)="logout()">
        <ion-icon name="log-out-outline" slot="start"></ion-icon>
        Logout
      </ion-button>
    </div>

  </div>
</ng-container>